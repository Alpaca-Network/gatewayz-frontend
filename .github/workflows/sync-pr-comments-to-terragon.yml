name: Sync PR Comments to Terragon Task

on:
  # Manual trigger to sync all comments at once
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to sync comments from'
        required: true
        type: number

# Prevent concurrent runs for the same PR
concurrency:
  group: pr-comments-${{ inputs.pr_number }}
  cancel-in-progress: false

# Required permissions for pushing to branches and commenting on PRs
permissions:
  contents: write
  pull-requests: write

jobs:
  sync-comments:
    name: Sync PR Comments to Terragon
    runs-on: ubuntu-latest

    steps:
      - name: Fetch PR Details
        id: pr_details
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ inputs.pr_number }}"

          # Get PR info
          PR_INFO=$(gh pr view "$PR_NUMBER" --repo "${{ github.repository }}" --json title,url,author,body,headRefName,headRepositoryOwner)

          PR_TITLE=$(echo "$PR_INFO" | jq -r '.title')
          PR_BRANCH=$(echo "$PR_INFO" | jq -r '.headRefName')
          HEAD_OWNER=$(echo "$PR_INFO" | jq -r '.headRepositoryOwner.login')
          REPO_OWNER="${{ github.repository_owner }}"

          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
          echo "pr_url=$(echo "$PR_INFO" | jq -r '.url')" >> $GITHUB_OUTPUT
          echo "pr_author=$(echo "$PR_INFO" | jq -r '.author.login')" >> $GITHUB_OUTPUT
          echo "pr_branch=$PR_BRANCH" >> $GITHUB_OUTPUT

          # Check if this is a fork PR (can't push to fork branches)
          if [ "$HEAD_OWNER" != "$REPO_OWNER" ]; then
            echo "is_fork=true" >> $GITHUB_OUTPUT
            echo "::warning::PR is from a fork ($HEAD_OWNER/$PR_BRANCH). Cannot push task file to fork."
          else
            echo "is_fork=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr_details.outputs.pr_branch }}
          fetch-depth: 0

      - name: Collect All PR Comments
        id: collect_comments
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ inputs.pr_number }}"

          # Create temporary file for comments
          COMMENTS_FILE=$(mktemp)

          echo "# PR Comments Summary" > "$COMMENTS_FILE"
          echo "" >> "$COMMENTS_FILE"
          echo "**PR**: [${{ steps.pr_details.outputs.pr_title }}](${{ steps.pr_details.outputs.pr_url }})" >> "$COMMENTS_FILE"
          echo "**Author**: \`@${{ steps.pr_details.outputs.pr_author }}\`" >> "$COMMENTS_FILE"
          echo "**Branch**: \`${{ steps.pr_details.outputs.pr_branch }}\`" >> "$COMMENTS_FILE"
          echo "" >> "$COMMENTS_FILE"

          # Collect inline review comments
          echo "## Code Review Comments" >> "$COMMENTS_FILE"
          echo "" >> "$COMMENTS_FILE"

          gh api "repos/${{ github.repository }}/pulls/$PR_NUMBER/comments" \
            --jq '.[] | "### \(.path):\(.line // .original_line // "N/A")\n**@\(.user.login)** at \(.created_at)\n> \(.body | gsub("\n"; "\n> "))\n"' \
            >> "$COMMENTS_FILE" 2>/dev/null || echo "No inline comments found" >> "$COMMENTS_FILE"

          echo "" >> "$COMMENTS_FILE"

          # Collect PR reviews
          echo "## Reviews" >> "$COMMENTS_FILE"
          echo "" >> "$COMMENTS_FILE"

          gh pr view "$PR_NUMBER" --json reviews \
            --jq '.reviews[] | select(.body != "") | "### \(.state) by @\(.author.login)\n> \(.body | gsub("\n"; "\n> "))\n"' \
            >> "$COMMENTS_FILE" 2>/dev/null || echo "No reviews with comments found" >> "$COMMENTS_FILE"

          echo "" >> "$COMMENTS_FILE"

          # Collect general PR comments (exclude bot comments to avoid noise)
          echo "## Discussion Comments" >> "$COMMENTS_FILE"
          echo "" >> "$COMMENTS_FILE"

          gh api "repos/${{ github.repository }}/issues/$PR_NUMBER/comments" \
            --jq '.[] | select(.user.type != "Bot") | "**@\(.user.login)** at \(.created_at)\n> \(.body | gsub("\n"; "\n> "))\n"' \
            >> "$COMMENTS_FILE" 2>/dev/null || echo "No discussion comments found" >> "$COMMENTS_FILE"

          # Output the comments file path
          echo "comments_file=$COMMENTS_FILE" >> $GITHUB_OUTPUT

          # Also output a summary count (exclude bot comments from counts)
          INLINE_COUNT=$(gh api "repos/${{ github.repository }}/pulls/$PR_NUMBER/comments" --jq 'length' 2>/dev/null || echo "0")
          REVIEW_COUNT=$(gh pr view "$PR_NUMBER" --json reviews --jq '[.reviews[] | select(.body != "")] | length' 2>/dev/null || echo "0")
          DISCUSSION_COUNT=$(gh api "repos/${{ github.repository }}/issues/$PR_NUMBER/comments" --jq '[.[] | select(.user.type != "Bot")] | length' 2>/dev/null || echo "0")

          echo "inline_count=$INLINE_COUNT" >> $GITHUB_OUTPUT
          echo "review_count=$REVIEW_COUNT" >> $GITHUB_OUTPUT
          echo "discussion_count=$DISCUSSION_COUNT" >> $GITHUB_OUTPUT

          # Store content for next step using unique delimiter to avoid collision with PR content
          COMMENTS_CONTENT=$(cat "$COMMENTS_FILE")
          DELIMITER="TERRAGON_COMMENTS_CONTENT_DELIMITER_${{ github.run_id }}"
          echo "comments_content<<${DELIMITER}" >> $GITHUB_OUTPUT
          echo "$COMMENTS_CONTENT" >> $GITHUB_OUTPUT
          echo "${DELIMITER}" >> $GITHUB_OUTPUT

      - name: Create Terragon Task Payload
        id: task_payload
        run: |
          PR_NUMBER="${{ inputs.pr_number }}"
          PR_TITLE="${{ steps.pr_details.outputs.pr_title }}"
          PR_URL="${{ steps.pr_details.outputs.pr_url }}"
          PR_BRANCH="${{ steps.pr_details.outputs.pr_branch }}"

          INLINE_COUNT="${{ steps.collect_comments.outputs.inline_count }}"
          REVIEW_COUNT="${{ steps.collect_comments.outputs.review_count }}"
          DISCUSSION_COUNT="${{ steps.collect_comments.outputs.discussion_count }}"

          TOTAL_COUNT=$((INLINE_COUNT + REVIEW_COUNT + DISCUSSION_COUNT))

          # Create task title
          TASK_TITLE="Address PR #${PR_NUMBER} feedback: ${PR_TITLE}"

          # Create task description
          cat << 'TASK_DESC' > /tmp/task_description.md
          ## Task: Address PR Feedback

          This task was automatically created to track feedback from PR #${{ inputs.pr_number }}.

          **Summary:**
          - Inline code comments: ${{ steps.collect_comments.outputs.inline_count }}
          - Reviews with comments: ${{ steps.collect_comments.outputs.review_count }}
          - Discussion comments: ${{ steps.collect_comments.outputs.discussion_count }}

          **PR Details:**
          - URL: ${{ steps.pr_details.outputs.pr_url }}
          - Branch: `${{ steps.pr_details.outputs.pr_branch }}`

          ---

          ${{ steps.collect_comments.outputs.comments_content }}

          ---

          ## Instructions

          1. Review each comment above
          2. Address code review comments by making the requested changes
          3. Respond to questions in the PR
          4. Mark resolved comments as resolved in GitHub
          5. Request re-review when ready
          TASK_DESC

          echo "task_title=$TASK_TITLE" >> $GITHUB_OUTPUT
          echo "total_comments=$TOTAL_COUNT" >> $GITHUB_OUTPUT

      - name: Create and Push Terragon Task File
        if: |
          steps.pr_details.outputs.is_fork != 'true' &&
          (steps.collect_comments.outputs.inline_count != '0' ||
           steps.collect_comments.outputs.review_count != '0' ||
           steps.collect_comments.outputs.discussion_count != '0')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ inputs.pr_number }}"
          TASK_TITLE="${{ steps.task_payload.outputs.task_title }}"
          PR_BRANCH="${{ steps.pr_details.outputs.pr_branch }}"

          echo "=== PR Comments Summary ==="
          echo "PR #$PR_NUMBER: ${{ steps.pr_details.outputs.pr_title }}"
          echo "Total comments to address: ${{ steps.task_payload.outputs.total_comments }}"
          echo ""
          echo "Task title: $TASK_TITLE"

          # Create a marker file that can be picked up by Terragon
          mkdir -p .terragon/pending-tasks

          TASK_FILE=".terragon/pending-tasks/pr-${PR_NUMBER}-$(date +%Y%m%d%H%M%S).md"

          cat << EOF > "$TASK_FILE"
          ---
          title: "$TASK_TITLE"
          pr_number: $PR_NUMBER
          pr_url: "${{ steps.pr_details.outputs.pr_url }}"
          branch: "$PR_BRANCH"
          created_at: "$(date -Iseconds)"
          status: pending
          ---

          $(cat /tmp/task_description.md)
          EOF

          echo ""
          echo "Task file created: $TASK_FILE"

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Add and commit the task file
          git add "$TASK_FILE"

          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: sync PR #$PR_NUMBER comments to Terragon task

          [skip ci]"

            # Push to the PR branch
            if ! git push origin "HEAD:$PR_BRANCH"; then
              echo "::error::Failed to push task file to branch $PR_BRANCH"
              exit 1
            fi

            echo "Successfully pushed task file to $PR_BRANCH"
          fi

      - name: Add PR Comment with Task Summary
        if: |
          steps.collect_comments.outputs.inline_count != '0' ||
          steps.collect_comments.outputs.review_count != '0' ||
          steps.collect_comments.outputs.discussion_count != '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ inputs.pr_number }}"
          IS_FORK="${{ steps.pr_details.outputs.is_fork }}"

          if [ "$IS_FORK" == "true" ]; then
            TASK_NOTE="Note: This PR is from a fork, so the task file could not be committed to the branch."
          else
            TASK_NOTE="The task file has been added to \`.terragon/pending-tasks/\` on branch \`${{ steps.pr_details.outputs.pr_branch }}\`."
          fi

          gh pr comment "$PR_NUMBER" --body "## Terragon Task Synced

          PR feedback has been synced to a Terragon task.

          **Summary:**
          - Inline code comments: ${{ steps.collect_comments.outputs.inline_count }}
          - Reviews with comments: ${{ steps.collect_comments.outputs.review_count }}
          - Discussion comments: ${{ steps.collect_comments.outputs.discussion_count }}

          $TASK_NOTE

          ---
          *This comment was automatically generated by the PR Comments Sync workflow.*"

      - name: Skip - No Comments
        if: |
          steps.collect_comments.outputs.inline_count == '0' &&
          steps.collect_comments.outputs.review_count == '0' &&
          steps.collect_comments.outputs.discussion_count == '0'
        run: |
          echo "No comments found on PR #${{ inputs.pr_number }}, skipping task creation."
