name: Claude on CI failure

on:
  workflow_run:
    workflows: ["CI Pipeline", "Run Tests"]  # Trigger on both CI workflows
    types: [completed]

jobs:
  run_claude_on_failure:
    # Security: Only run for failures from the same repository (not forks)
    if: >
      ${{ github.event.workflow_run.conclusion == 'failure' &&
          github.event.workflow_run.head_repository.full_name == github.repository }}
    runs-on: ubuntu-latest

    steps:
      - name: Find associated PR number
        id: find_pr
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b  # v7.1.0
        with:
          script: |
            const { owner, repo } = context.repo;
            const sha = context.payload.workflow_run.head_sha;
            const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner, repo, commit_sha: sha
            });
            if (prs.data.length === 0) {
              core.warning("No PR found for this commit. Skipping Claude run.");
              return;
            }
            core.setOutput("pr", prs.data[0].number.toString());

      - name: Run Claude Code (failure diagnostics)
        if: ${{ steps.find_pr.outputs.pr }}
        uses: anthropics/claude-code-action@8a1c4371755898f67cd97006ba7c97702d5fc4bf  # v1.0.16
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          pr_number: ${{ steps.find_pr.outputs.pr }}
          mode: "review"
          system_prompt: |
            You are a CI triage assistant for the Gatewayz backend API. Summarize why the workflow failed,
            identify the likely source of the error, and suggest minimal code changes to fix it.
            Focus on immediate blockers.

            Common failure patterns to check:
            - Test failures (pytest assertion errors, timeout issues)
            - Linting errors (ruff, black, isort, mypy)
            - Security scan failures (bandit, safety)
            - Import/dependency errors
            - Coverage drops below 25% threshold
            - Integration test failures (endpoint tests, auth, payments)
            - Build/startup errors
