name: Claude on CI failure

on:
  workflow_run:
    workflows: ["CI Pipeline", "Run Tests"]  # Trigger on both CI workflows
    types: [completed]

jobs:
  run_claude_on_failure:
    # Security: Only run for failures from the same repository (not forks)
    if: >
      ${{ github.event.workflow_run.conclusion == 'failure' &&
          github.event.workflow_run.head_repository.full_name == github.repository }}
    runs-on: ubuntu-latest

    # Required permissions for Claude Code action
    permissions:
      id-token: write      # Required for OIDC token
      contents: write      # Required to push commits
      pull-requests: write # Required to comment on PRs
      actions: read        # Required to read workflow run data

    steps:
      - name: Run Claude Code (fix CI failures and push)
        uses: anthropics/claude-code-action@8a1c4371755898f67cd97006ba7c97702d5fc4bf  # v1.0.16
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          use_commit_signing: true
          claude_args: "--max-turns 15"
          prompt: |
            The CI pipeline has failed on this PR. Your task is to:

            1. Analyze the CI failure logs to identify the root cause
            2. Implement the necessary code fixes to resolve the failures
            3. Commit and push your changes to this PR branch

            Common failure patterns in this Gatewayz backend codebase:
            - Test failures: pytest assertion errors, timeout issues, mock configuration
            - Linting errors: ruff, black, isort, mypy type errors
            - Security scans: bandit warnings, safety vulnerability checks
            - Import/dependency errors: missing packages, circular imports
            - Coverage drops: ensure coverage stays above 25% threshold
            - Integration test failures: endpoint tests, auth, payments, database
            - Build/startup errors: FastAPI app initialization, missing env vars

            After identifying the issue, make the minimal code changes needed to fix it.
            Test your changes if possible, then commit and push to the PR.

            Use clear commit messages that explain what was fixed and why.
