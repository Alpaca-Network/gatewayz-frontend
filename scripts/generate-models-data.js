const fs = require('fs');
const path = require('path');

const API_BASE_URL = process.env.NEXT_PUBLIC_API_BASE_URL || 'https://api.gatewayz.ai';

async function fetchModels() {
  try {
    const response = await fetch(`${API_BASE_URL}/v1/models?gateway=all&limit=50000`);
    if (!response.ok) throw new Error('Failed to fetch models');
    const data = await response.json();
    return data.data || [];
  } catch (error) {
    console.error('Failed to fetch models:', error);
    return [];
  }
}

function transformToStaticModel(apiModel) {
  const contextNum = apiModel.context_length || 0;
  const contextK = Math.round(contextNum / 1000);
  const tokens = `${contextK}k-${contextK}k`;
  
  return {
    name: apiModel.name,
    isFree: false, // Default, can be refined
    tokens,
    category: apiModel.architecture?.input_modalities?.includes('image') ? 'vision' : 'text',
    description: apiModel.description || apiModel.name,
    developer: apiModel.provider_slug || 'unknown',
    context: contextNum,
    inputCost: parseFloat(apiModel.pricing?.prompt || '0'),
    outputCost: parseFloat(apiModel.pricing?.completion || '0'),
    modalities: apiModel.architecture?.input_modalities || ['text'],
    series: apiModel.name.split('/')[0] || apiModel.provider_slug || 'unknown',
    supportedParameters: apiModel.supported_parameters || ['temperature', 'max_tokens'],
    requiredTier: undefined
  };
}

async function main() {
  const apiModels = await fetchModels();
  if (apiModels.length === 0) {
    console.error('No models fetched, skipping update');
    return;
  }
  const staticModels = apiModels.map(transformToStaticModel);

  const fileContent = `// This file is auto-generated by generate-models-data.js - DO NOT EDIT MANUALLY
export interface Model {
  name: string;
  isFree: boolean;
  tokens: string;
  category: string;
  description: string;
  developer: string;
  context: number;
  inputCost: number;
  outputCost: number;
  modalities: string[];
  series: string;
  supportedParameters: string[];
  requiredTier?: string;
  is_private?: boolean;
}

export const models: Model[] = ${JSON.stringify(staticModels, null, 2)};
`;

  const filePath = path.join(__dirname, '..', 'src', 'lib', 'models-data.ts');
  fs.writeFileSync(filePath, fileContent, 'utf8');
  console.log(`Generated ${staticModels.length} models in ${filePath}`);
}

main().catch(console.error);