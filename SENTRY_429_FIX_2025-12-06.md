# Sentry 429 Rate Limit Fix - December 6, 2025

## Issue

Users are experiencing **429 (Too Many Requests)** errors from the Sentry monitoring tunnel:

```
POST https://beta.gatewayz.ai/monitoring?o=...&p=...&r=us 429 (Too Many Requests)
```

Additionally, console warnings are being sent to Sentry:
```
[ChatLayout] Pending prompt timed out after 15000 ms, clearing optimistic UI
```

These informational messages are consuming Sentry event quota unnecessarily.

## Root Causes

1. **Client-Side Rate Limiting Too Lenient**
   - Was set to 20 events/minute
   - Still hitting 429s with normal usage

2. **Server-Side Rate Limiting Mismatched**
   - Tunnel route allowed 50 requests/minute
   - Client could send more events than tunnel could handle

3. **Session Replay Integration Active**
   - `replaysOnErrorSampleRate: 0.1` was sending replay data
   - Replay events consume significant quota

4. **Informational Messages Being Sent**
   - Console warnings like "Pending prompt timed out" being captured
   - WalletConnect relay errors (non-critical) being sent
   - These are informational, not actual errors

5. **Insufficient Event Filtering**
   - Not all non-critical errors were being filtered before sending

## Fixes Applied

### 1. Client-Side Rate Limiting (instrumentation-client.ts)

**Reduced event frequency:**
```typescript
// BEFORE:
maxEventsPerMinute: 20,
dedupeWindowMs: 30000,  // 30 seconds
maxBreadcrumbs: 30,

// AFTER:
maxEventsPerMinute: 10,     // REDUCED from 20
dedupeWindowMs: 60000,      // INCREASED from 30s to 60s
maxBreadcrumbs: 20,         // REDUCED from 30
```

**Impact:** Cuts client-side event volume in half

### 2. Transaction Sampling (instrumentation-client.ts)

**Reduced transaction traces:**
```typescript
// BEFORE:
tracesSampleRate: 0.1,  // 10%

// AFTER:
tracesSampleRate: 0.05,  // 5% - halved
```

**Impact:** Reduces performance trace volume by 50%

### 3. Session Replay Disabled (instrumentation-client.ts)

**Completely disabled replay integration:**
```typescript
// BEFORE:
replaysOnErrorSampleRate: 0.1,  // 10% of error sessions
replaysSessionSampleRate: 0,
integrations: [
  Sentry.replayIntegration({ maskAllText: true, blockAllMedia: true }),
],

// AFTER:
replaysOnErrorSampleRate: 0,    // DISABLED
replaysSessionSampleRate: 0,
integrations: [
  // Replay integration completely removed
],
```

**Impact:** Eliminates all replay event traffic (major quota saver)

### 4. Enhanced Event Filtering (instrumentation-client.ts)

**Added filters for informational messages:**
```typescript
// Filter out pending prompt timeout warnings (informational)
if (
  errorMessage.includes('Pending prompt timed out') ||
  eventMessage.includes('Pending prompt timed out') ||
  errorMessage.includes('timed out after') ||
  eventMessage.includes('clearing optimistic UI')
) {
  console.debug('[Sentry] Filtered out pending prompt timeout warning');
  return true;
}

// Filter out WalletConnect relay errors (non-critical)
if (
  errorMessage.includes('walletconnect') ||
  errorMessage.includes('relay.walletconnect.com') ||
  errorMessage.includes('WebSocket error 1006') ||
  errorMessage.includes('explorer-api.walletconnect')
) {
  console.debug('[Sentry] Filtered out non-critical WalletConnect relay error');
  return true;
}
```

**Impact:** Prevents non-critical informational messages from consuming quota

### 5. Server-Side Rate Limiting (src/app/monitoring/route.ts)

**Matched server limits to client:**
```typescript
// BEFORE:
maxRequestsPerMinute: 50,
maxRequestsPerSecond: 5,

// AFTER:
maxRequestsPerMinute: 15,  // REDUCED from 50
maxRequestsPerSecond: 2,   // REDUCED from 5
```

**Impact:** Server tunnel now properly gates client requests

### 6. Console Logging Reduction

**Changed filtered event logs:**
```typescript
// BEFORE:
console.warn('[Sentry] Filtered out...')

// AFTER:
console.debug('[Sentry] Filtered out...')
```

**Impact:** Reduces console noise, makes actual errors more visible

---

## Expected Results

### Before Fix:
- ❌ 20+ Sentry events per minute per client
- ❌ 429 errors in browser console
- ❌ Informational warnings consuming quota
- ❌ Session replays adding event volume
- ❌ Tunnel rate limit (50/min) higher than needed

### After Fix:
- ✅ Maximum 10 Sentry events per minute per client
- ✅ No 429 errors (strict client and server limiting)
- ✅ Informational warnings filtered out
- ✅ Session replays completely disabled
- ✅ Tunnel rate limit (15/min) matches client output

---

## Monitoring

### Key Metrics to Track

**Sentry Dashboard:**
1. **Event Rate:** Should drop by 50-70%
2. **429 Errors:** Should drop to 0
3. **Quota Usage:** Should stay well under limit

**Browser Console:**
1. **429 Errors:** Should disappear completely
2. **Debug Logs:** `[Sentry] Filtered out...` messages (debug level)
3. **Actual Errors:** Real errors should still be captured

### Expected Event Volume

**Per User Session:**
- Real errors: 0-5 per session (actual issues)
- Filtered out: 10-20 per session (informational)
- Sent to Sentry: 0-5 per session (only real errors)

**System-Wide (100 concurrent users):**
- Before: ~2000 events/hour (20/min × 100 users)
- After: ~500 events/hour (5/min × 100 users)
- Reduction: **75% fewer Sentry events**

---

## Files Modified

### 1. `instrumentation-client.ts`
- Reduced `maxEventsPerMinute` from 20 to 10
- Increased `dedupeWindowMs` from 30s to 60s
- Reduced `maxBreadcrumbs` from 30 to 20
- Reduced `tracesSampleRate` from 0.1 to 0.05
- Disabled `replaysOnErrorSampleRate` (was 0.1, now 0)
- Removed replay integration entirely
- Added filters for pending prompt timeouts
- Added filters for WalletConnect relay errors
- Changed filter logs from `console.warn` to `console.debug`

### 2. `src/app/monitoring/route.ts`
- Reduced `maxRequestsPerMinute` from 50 to 15
- Reduced `maxRequestsPerSecond` from 5 to 2

---

## Testing

### Manual Testing Checklist

**1. Load Application:**
- ✅ Open https://beta.gatewayz.ai in browser
- ✅ Open DevTools Console
- ✅ Watch for 429 errors

**Expected:** No 429 errors should appear

**2. Trigger Chat Interaction:**
- ✅ Send a chat message
- ✅ Let pending prompt timeout occur (wait 15s)
- ✅ Check console for filtered messages

**Expected:**
- Console should show: `[Sentry] Filtered out pending prompt timeout warning`
- No event sent to Sentry

**3. Check Sentry Dashboard:**
- ✅ Go to Sentry project
- ✅ Check event volume over last hour
- ✅ Verify no 429-related errors

**Expected:**
- Event rate should be 50-70% lower than before
- No "Too Many Requests" issues

**4. Verify Real Errors Still Captured:**
- ✅ Trigger an actual error (e.g., invalid API call)
- ✅ Check Sentry dashboard

**Expected:**
- Real errors should still appear in Sentry
- Only informational/non-critical messages filtered

---

## Rollback Plan

If issues arise, revert these files:
1. `instrumentation-client.ts`
2. `src/app/monitoring/route.ts`

```bash
git checkout HEAD~1 -- instrumentation-client.ts src/app/monitoring/route.ts
```

Or adjust individual settings:
- Increase `maxEventsPerMinute` back to 15-20
- Re-enable session replay if needed for debugging
- Remove event filters if over-filtering

---

## Future Improvements

### 1. Distributed Rate Limiting
**Current:** In-memory rate limiting (resets on deployment)
**Better:** Redis-based rate limiting for multi-instance deployments

### 2. Dynamic Rate Adjustment
**Current:** Static limits
**Better:** Adjust limits based on Sentry quota usage via API

### 3. Error Budget System
**Current:** Filter all non-critical errors
**Better:** Allow X% of informational errors for debugging

### 4. Selective Replay
**Current:** Replays completely disabled
**Better:** Enable replay only for high-priority error types

---

## Related Documentation

- `FRONTEND_ERROR_STATUS_2025-12-06.md` - Overall error status
- `FRONTEND_ERROR_ANALYSIS.md` - Error analysis
- `ERROR_MONITORING_GUIDE.md` - Monitoring guide
- `SENTRY_ERROR_ANALYSIS.md` - Sentry integration details

---

## Deployment Notes

### Pre-Deployment:
1. ✅ All TypeScript compilation passes
2. ✅ No test failures
3. ✅ Rate limit values validated

### Deployment:
- Deploy to production via normal CI/CD
- No database migrations required
- No environment variable changes needed

### Post-Deployment (First 2 Hours):
1. Monitor browser console for 429 errors
2. Check Sentry dashboard for event volume
3. Verify real errors still being captured
4. Watch for any over-filtering issues

### Post-Deployment (First 24 Hours):
1. Compare event volume before/after
2. Check quota usage trends
3. Validate error capture completeness
4. Gather user feedback

---

## Success Criteria

✅ **Primary Goals:**
1. Zero 429 errors in browser console
2. 50-70% reduction in Sentry event volume
3. Real errors still captured correctly

✅ **Secondary Goals:**
1. Reduced console noise (debug vs warn logs)
2. Better event filtering (no informational spam)
3. Improved quota efficiency

---

**Fix Applied:** December 6, 2025
**Status:** Ready for deployment
**Risk Level:** Low (conservative rate limits, backward compatible)
**Rollback:** Easy (revert two files)

---

## Summary

This fix addresses the Sentry 429 rate limit errors by implementing aggressive rate limiting on both client and server sides, disabling session replay integration, and filtering out informational messages that were consuming quota. The changes are conservative and reversible, with clear success criteria and monitoring plan.

**Key Takeaway:** We're trading detailed monitoring (session replays, high event volume) for stability (no 429 errors, efficient quota usage). Real errors will still be captured, but informational noise will be filtered out.
